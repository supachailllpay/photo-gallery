<link rel='import' href='../polymer/polymer-element.html'>
<link rel='import' href='../shadycss/apply-shim.html'>

<link rel='import' href='anime.html'>
<link rel='import' href='photo-gallery-icon.html'>

<dom-module id='photo-gallery'>
  <template>

    <style>
      :host {
        display: block;
        height: 100vh;
      }

      .grid {
        display: flex;
        flex-wrap: wrap;
        margin: -4px;
      }

      .grid ::slotted(.item) {
        flex-grow: 1;
        margin: 4px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        cursor: pointer;
      }

      .slideshow {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 2400;

        display: none;

        /* background-color: rgba(0, 0, 0, 0.816); */
        background-color: rgba(60, 60, 60, 0.9);
        
        -webkit-user-select: none; /* Chrome, Opera, Safari */
        -moz-user-select: none; /* Firefox 2+ */
        -ms-user-select: none; /* IE 10+ */
        user-select: none; /* Standard syntax */        
      }

      .slide {
        position: absolute;
        top: 0px;
        right: 0px;
        bottom: 0px;
        left: 0px;
        max-width: 100%;
        max-height: 100%;
        margin: auto;

        display: block;

      }

      .chevron {
        position: absolute;
        top: 50%;
        margin-top: -18px;
        transition: opacity 0.25s ease-in-out;
        background-color: rgba(255, 255, 255, 0.445);

        opacity: 0.2;
        --photo-gallery-icon: {
          width: 36px;
          height: 36px;
        }
      }

      .chevron:hover {
        opacity: 1;
      }

      .chevron:first-of-type {
        left: 24px;
      }

      .chevron:last-of-type {
        right: 24px;
      }

      .toolbar {
        position: absolute;
        /* position: fixed; */
        width: 100%;
        height: 100vh;
        height: 0px;
        top: 0px;
        right: 0px;
        left: 0px;
        z-index: 10001;
        height: 64px;
        background: linear-gradient(black, transparent);
        /* background-image: linear-gradient(black, transparent); */

        /* -ms-transform: translateY(-100%);
        -webkit-transform: translateY(-100%);
        transform: translateY(-100%);
        

        -ms-transition: transform 0.25s ease-in-out 0.05s;
        -webkit-transition: transform 0.25s ease-in-out 0.05s;
        transition: transform 0.25s ease-in-out 0.05s; */

        /* visibility: hidden; */
        display: block;
        /* will-change: transform; */
      }

      .toolbar[visible] {

        /* background: green; */
        /* z-index: 10001; */
        /* -ms-transform: rotate(0); /* IE 9 */
        /* -webkit-transform: rotate(0); /* Chrome, Safari, Opera */        
        /* transform: translateY(0);  */ 

        /* visibility: visible; */
        /* display: block; */
        top: 10px;
        left: 10px;
      }

      .back {
        background-color: rgba(255, 255, 255, 0.213);
        position: relative;
        left: 10px;
        top: 10px;
        padding: 10px 10px;
      }
    </style>

    <div class='grid' on-click='open'>
      <slot id='grid'></slot>
    </div>

    <div class='slideshow' id='slideshow'>
      <!-- <div class='toolbar' visible$='[[isFullScreen]]' > -->
       <!-- <div id="toolbar" class='toolbar' >
              <slot name='toolbar'>
          <button on-click="close">BACK</button>
          <photo-gallery-icon class='back' icon='arrow-back' on-click='close'></photo-gallery-icon>
        </slot>
      </div> -->

      <!-- <button on-click="close">BACK</button> -->
      <photo-gallery-icon class='back' icon='arrow-back' on-click='close'></photo-gallery-icon>


      <img class='slide' id='slide'>
      <img class='slide' style='display: none' id='exitSlide'>
      <photo-gallery-icon class='chevron' icon='chevron-left' on-click='previous'></photo-gallery-icon>
      <photo-gallery-icon class='chevron' icon='chevron-right' on-click='next'></photo-gallery-icon>
    </div>


  </template>
  <script>
    /**
     * `photo-gallery`
     * A photo gallery element based on Polymer
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PhotoGallery extends Polymer.Element {
      static get is () {
        return 'photo-gallery'
      }

      static get properties () {
        return {
          height: {
            type: Number,
            value: 240
          },
          selected: {
            type: Number,
            value: -1,
            notify: true
          },
          isFullScreen: {

          }
        }
      }

      anime (properties) {
        let timing = { duration: 250, easing: 'easeInOutQuad' }
        window.anime(Object.assign(timing, properties))
      }

      closest (element, className) {
        while (element) {
          if (element.classList.contains(className)) return element
          element = element.parentElement
        }
      }

      getAspectRatio (url) {
        let match = url.match(/aspect-ratio=([.\d]+)/)
        return match ? parseFloat(match[1]) : 1
      }

      updateItemsStyle () {
        this.items.forEach(item => {
          let url = item.dataset.url
          let aspectRatio = this.getAspectRatio(url)
          item.style.width = this.height * aspectRatio + 'px'
          item.style.height = this.height + 'px'
          item.style.backgroundImage = `url(${url})`
        })
      }

      updateItems () {
        this.items = this.$.grid.assignedNodes()
          .filter(node => node.nodeType === Node.ELEMENT_NODE)
          .filter(node => node.classList.contains('item'))
        this.updateItemsStyle()
      }

      toggleScrollBar (enabled) {
        let html = document.documentElement
        let body = document.body
        if (!enabled) {
          let top = -html.scrollTop + 'px'
          body.style.position = 'fixed'
          body.style.top = top
        } else {
          let top = -parseInt(body.style.top, 10)
          body.style.position = ''
          body.style.top = ''
          html.scrollTop = top
        }
      }

      open (event) {

        let item = this.closest(event.target, 'item')
        if (!item) return

        let slide = this.$.slide
        let rect = item.getBoundingClientRect()
        slide.src = item.dataset.url
        this.$.slideshow.style.display = 'block';
        // this.$.toolbar.style.display = 'block';
        // this.$.slideshow.style.visibility = 'visible';

        this.anime({
          targets: slideshow,
          top: [rect.top, 0],
          left: [rect.left, 0],
          bottom: [window.innerHeight - rect.top - rect.height, 0],
          right: [window.innerWidth - rect.left - rect.width, 0]
        })

        this.selected = this.items.indexOf(item)
        this.isFullScreen = true
        this.toggleScrollBar(false)
      }

      close () {
        let slide = this.$.slide
        let slideshow = this.$.slideshow
        this.anime({
          targets: slideshow,
          opacity: [1, 0],
          complete () {
            slide.src = ''
            slideshow.removeAttribute('style')
          }
        })
        this.selected = -1
        this.isFullScreen = false
        this.toggleScrollBar(true)
      }

      change (direction) {
        let nextItem = this.items[this.selected + direction]
        if (!nextItem) return

        let slide = this.$.slide
        let exitSlide = this.$.exitSlide
        exitSlide.src = slide.src
        slide.src = nextItem.dataset.url
        this.anime({
          targets: slide,
          opacity: [0, 1]
        })
        exitSlide.style.display = 'block'
        this.anime({
          targets: exitSlide,
          opacity: [1, 0],
          translateX: ['0', `${-direction}0%`],
          complete () {
            exitSlide.style.display = 'none'
          }
        })
        this.selected += direction
      }

      previous () {
        this.change(-1)
      }

      next () {
        this.change(1)
      }

      ready () {
        super.ready()

        let grid = this.$.grid
        this.updateItems()
        grid.addEventListener('slotchange', this.updateItems.bind(this))
      }
    }

    window.customElements.define(PhotoGallery.is, PhotoGallery)

  </script>
</dom-module>
